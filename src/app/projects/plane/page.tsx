"use client";
import {
  BirdFlapping,
  Button,
  Buttons,
  Flock,
  Headline,
  PageWrapper,
  PlanePlaceholder,
  Subtitle,
} from "./style/style";
import gsap from "gsap";
import { useGSAP } from "@gsap/react";
import { useEffect, useRef, useState } from "react";

export default function ShadowMove() {
  const [shadowType, setShadowType] = useState("plane");
  const mouse = useRef({
    //true position of cursor
    x: 0,
    y: 0,
  });

  const delayedMouse = useRef({
    x: 0,
    y: 0,
  });
  const cursorFollower = useRef<HTMLDivElement>(null);
  const bird = useRef<HTMLDivElement>(null);

  const manageInputMove = (e: MouseEvent | TouchEvent) => {
    let clientX, clientY;

    // Check if it's a touch event and get the first touch point's coordinates
    if ("touches" in e) {
      if (e.touches.length > 0) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        return; // No active touch, exit
      }
    } else {
      // It's a mouse event
      clientX = e.clientX;
      clientY = e.clientY;
    }
    mouse.current = { x: clientX, y: clientY };
  };

  //linear interpolation
  const lerp = (x: number, y: number, a: number) => x * (1 - a) + y * a;

  const movePlane = (x: number, y: number, rotation: number) => {
    gsap.set(cursorFollower.current, {
      x,
      y,
      xPercent: -50,
      yPercent: -50,
      rotation: rotation ? rotation : 0,
      transformOrigin: "50% 50%",
    });
  };

  const animate = () => {
    const { x, y } = delayedMouse.current;
    const lerpSpeed = shadowType == "plane" ? 0.005 : 0.001;

    let opposite = mouse.current.y - y;
    let adjacent = mouse.current.x - x;
    let rotationRad = Math.atan2(opposite, adjacent);
    let rotation = rotationRad * (180 / Math.PI);

    delayedMouse.current = {
      x: lerp(x, mouse.current.x, lerpSpeed),
      y: lerp(y, mouse.current.y, lerpSpeed),
    };
    movePlane(delayedMouse.current.x, delayedMouse.current.y, rotation);
    window.requestAnimationFrame(animate);
  };

  useEffect(() => {
    const centerX = window.innerWidth / 2;
    const centerY = window.innerHeight / 2;
    if (bird.current) {
      // Total distance is the width of 8 frames (8 * 196px = 1568px)
      const targetDistance = -74 * 6;
      const birdSprites = bird.current.querySelectorAll("div");

      gsap.to(birdSprites, {
        // Use the calculated pixel value
        backgroundPositionX: `${targetDistance}px`,
        duration: 1, // Example duration, adjust for desired speed

        // 8 steps are needed for 9 total frames
        ease: `steps(6)`,
        repeat: -1,
        stagger: {
          each: 0.05, // Delay each subsequent bird's animation start by 0.05 seconds
          repeat: -1, // Ensures the stagger pattern repeats every time the main animation loops
          from: "start",
        },
      });
    }
    mouse.current = { x: centerX, y: centerY };
    delayedMouse.current = { x: centerX, y: centerY };
    movePlane(centerX, centerY, 0);

    animate();
    // Use the updated handler function
    window.addEventListener("mousemove", manageInputMove);

    // ADDED: Listener for mobile dragging
    window.addEventListener("touchmove", manageInputMove);

    return () => {
      window.removeEventListener("mousemove", manageInputMove);
      // ADDED: Cleanup for touch listener
      window.removeEventListener("touchmove", manageInputMove);
    };
  }, [shadowType]);
  return (
    <PageWrapper>
      <Headline> Shadow Cursors</Headline>
      <Buttons>
        <Button
          active={shadowType === "plane"}
          onClick={() => setShadowType("plane")}
        >
          <svg
            width="32"
            height="39"
            viewBox="0 0 45 54"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <g filter="url(#filter0_f_1047_5)">
              <path
                d="M38.6056 27.8214C41.2878 26.9986 41.7174 24.9572 41.597 24.0394C39.9114 20.9797 36.7801 23.4425 34.3958 23.2999C32.4883 23.1859 31.7549 22.0478 31.6267 21.493C31.4052 20.0587 30.3616 16.765 30.0932 16.1112C28.7625 12.869 28.5172 11.6938 27.9408 10.4421L27.9408 10.442C27.3643 9.19021 25.8273 5.85224 25.2459 4.15435C24.7807 2.79603 24.1817 2.91408 23.9404 3.1429C23.563 3.17989 22.461 3.32029 21.0719 3.58591C19.6827 3.85152 19.8701 4.89946 20.1374 5.39023L20.9079 10.379L21.8035 16.1784C21.9962 17.4256 23.5814 21.0754 24.0188 22.6679C24.3688 23.9419 24.0568 24.7051 23.857 24.9275C19.4474 26.1406 10.5101 28.5466 10.038 28.4663C9.44791 28.3659 9.19752 26.7446 8.20338 24.855C7.20925 22.9654 6.74891 23.292 4.68141 23.5474C3.02742 23.7518 2.89915 24.8229 3.04176 25.333C3.12723 26.5754 3.42217 29.4498 3.91815 31.0077C4.41413 32.5656 6.72784 36.6605 7.82269 38.5132C8.6702 38.4887 10.533 38.2862 11.2043 37.6717C11.8756 37.0573 11.232 33.0279 10.8263 31.09C12.3696 31.8222 22.2245 30.7556 26.9591 30.1309C27.7864 33.8339 31.9202 39.5163 33.4714 42.5329C35.0227 45.5495 36.4163 49.6121 36.9775 49.5254C37.5387 49.4387 40.7622 48.8132 41.3903 48.3331C42.0185 47.853 40.2123 43.5988 39.4042 40.0205C38.5962 36.4422 35.6478 31.4067 35.5226 30.596C35.3974 29.7854 35.2529 28.85 38.6056 27.8214Z"
                fill="#494949"
              />
            </g>
            <defs>
              <filter
                id="filter0_f_1047_5"
                x="0"
                y="0"
                width="44.6133"
                height="52.5273"
                filterUnits="userSpaceOnUse"
                color-interpolation-filters="sRGB"
              >
                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                <feBlend
                  mode="normal"
                  in="SourceGraphic"
                  in2="BackgroundImageFix"
                  result="shape"
                />
                <feGaussianBlur
                  stdDeviation="1.5"
                  result="effect1_foregroundBlur_1047_5"
                />
              </filter>
            </defs>
          </svg>
          <p> Plane</p>
        </Button>
        <Button
          active={shadowType === "birds"}
          onClick={() => setShadowType("birds")}
        >
          <svg
            width="36"
            height="43"
            viewBox="0 0 36 43"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <g filter="url(#filter0_f_1050_1382)">
              <path
                d="M4.69936 5.16139C4.92275 5.20948 5.14695 5.25377 5.3716 5.29545C6.78232 5.57714 7.4829 5.85478 8.37901 7.02035C9.37365 8.19919 9.37365 8.19919 10.608 9.10273C10.9265 9.30829 10.9265 9.30829 11.068 9.73728C12.0955 9.69009 13.1229 9.6429 14.1815 9.59428C14.2749 9.40553 14.3684 9.21677 14.4646 9.0223C15.0359 8.61343 15.473 8.43144 16.1629 8.32519C16.8389 8.21326 17.1614 7.96276 17.6434 7.48732C17.8612 7.30634 17.8612 7.30634 18.2769 7.25272C18.4214 7.27926 18.4214 7.27926 18.5688 7.30634C18.7593 8.19855 18.7593 8.19855 18.5334 8.70056C18.2858 9.0223 18.2858 9.0223 18.0768 9.20216C17.7805 9.54455 17.6969 9.89512 17.5605 10.3271C17.2444 11.2059 16.8432 11.7188 16.1474 12.3252C15.693 12.7872 15.7055 13.2981 15.6764 13.9289C15.6795 14.5258 15.735 14.8358 16.1364 15.2784C16.2532 15.3943 16.2532 15.3943 16.3724 15.5124C16.7035 15.8676 16.8344 16.2955 17.012 16.7441C17.1968 17.0327 17.3852 17.319 17.5781 17.6021C17.7838 17.9599 17.8808 18.2507 17.985 18.6567C18.1645 19.241 18.419 19.7386 18.8519 20.176C18.8843 20.5693 18.8782 20.8329 18.7142 21.1943C18.5176 21.7511 18.5037 22.2791 18.4804 22.8662C18.4749 22.9789 18.4694 23.0916 18.4638 23.2077C18.4505 23.4841 18.4388 23.7605 18.4273 24.0369C18.1938 24.1313 17.9603 24.2257 17.7197 24.3229C17.7197 24.4173 17.7197 24.5117 17.7197 24.6089C17.4018 24.6592 17.4018 24.6592 17.012 24.6089C16.7152 24.2637 16.7152 24.2637 16.4371 23.8046C16.345 23.6553 16.2528 23.506 16.1579 23.3521C16.0662 23.2006 15.9744 23.0491 15.8798 22.893C15.7786 22.7514 15.6773 22.6098 15.573 22.464C15.2923 21.9996 15.2076 21.6594 15.1368 21.1234C15.1157 20.9719 15.0945 20.8203 15.0727 20.6642C15.0588 20.5503 15.045 20.4364 15.0307 20.319C14.9373 20.319 14.8439 20.319 14.7476 20.319C14.4452 19.2274 14.152 18.1615 14.04 17.0301C13.9933 16.9829 13.9466 16.9357 13.8985 16.8871C13.8882 16.5745 13.8866 16.2615 13.8896 15.9487C13.8909 15.7775 13.8922 15.6062 13.8935 15.4298C13.8952 15.2972 13.8968 15.1647 13.8985 15.0282C13.0393 14.9656 12.7074 15.2157 12.0642 15.7493C11.8078 15.998 11.6356 16.2136 11.4572 16.5207C11.2095 16.8871 11.2095 16.8871 10.8734 16.9944C10.1739 16.7924 9.8051 16.2818 9.44155 15.6789C8.86539 14.5787 8.86539 14.5787 8.94511 13.8842C9.27981 13.5557 9.62412 13.3294 10.0242 13.0888C10.4572 12.828 10.4572 12.828 10.7849 12.4542C10.7917 12.1683 10.7922 11.8821 10.7849 11.5962C10.5471 11.5702 10.5471 11.5702 10.3045 11.5437C10.0961 11.5196 9.88768 11.4954 9.67927 11.4711C9.57483 11.4599 9.47038 11.4486 9.36278 11.437C8.84391 11.3754 8.53759 11.3217 8.09596 11.0243C7.80269 10.9326 7.50756 10.8468 7.21143 10.7651C6.22031 10.4646 5.6212 10.1053 4.89395 9.35298C4.58807 9.00785 4.58807 9.00785 4.22116 8.89438C3.79599 8.7132 3.56093 8.49665 3.23988 8.16432C3.14118 8.06404 3.04248 7.96377 2.9408 7.86045C2.718 7.59233 2.718 7.59233 2.718 7.30634C2.6246 7.30634 2.53119 7.30634 2.43495 7.30634C2.05766 6.6551 1.96571 6.19962 2.01038 5.44738C3.00302 4.87717 3.61605 4.71361 4.69936 5.16139Z"
                fill="#585858"
              />
              <path
                d="M8.74588 21.8016C8.85826 21.8314 8.97064 21.8613 9.08643 21.8921C9.13313 21.9864 9.17984 22.0808 9.22795 22.1781C9.43918 22.2124 9.65188 22.2376 9.86482 22.2585C10.8269 22.4309 11.2959 23.0341 11.9169 23.751C12.0512 23.8894 12.1866 24.0268 12.3238 24.1621C12.6246 24.466 12.6246 24.466 12.828 24.7073C13.0584 24.9281 13.0584 24.9281 13.4649 25.0201C13.9845 25.213 14.1662 25.4324 14.4644 25.896C14.4644 25.9903 14.4644 26.0847 14.4644 26.182C14.9658 26.1787 15.4668 26.1676 15.9681 26.1551C16.1095 26.1543 16.2509 26.1535 16.3965 26.1526C17.3542 26.1238 17.7397 25.9869 18.4271 25.324C18.8417 25.1955 18.8417 25.1955 19.2586 25.1274C20.0488 24.9592 20.4614 24.6835 21.0005 24.0839C21.2576 23.894 21.2576 23.894 21.6429 23.9365C21.7493 23.9696 21.8556 24.0028 21.9652 24.037C21.9475 24.4839 21.9475 24.4839 21.8237 25.038C21.6119 25.2334 21.3998 25.4285 21.1841 25.6195C20.8935 26.0029 20.8442 26.363 20.7534 26.8344C20.5766 27.7462 20.3269 28.1187 19.5764 28.6626C19.1028 29.0561 18.8785 29.3108 18.7737 29.9351C18.753 30.9606 18.889 31.8144 19.2762 32.7598C19.3696 32.7598 19.4631 32.7598 19.5593 32.7598C19.7899 33.1175 19.9876 33.489 20.1912 33.863C20.3884 34.2316 20.3884 34.2316 20.833 34.3328C21.1717 34.8568 21.419 35.3628 21.6291 35.9504C21.7814 36.4745 21.7814 36.4745 22.1067 36.7637C22.1421 37.1212 22.1421 37.1212 22.1067 37.4787C22.0133 37.5731 21.9199 37.6674 21.8237 37.7647C21.776 38.0645 21.776 38.0645 21.775 38.4082C21.7688 38.5984 21.7688 38.5984 21.7623 38.7925C21.7577 38.9915 21.7577 38.9915 21.7529 39.1946C21.7468 39.4568 21.7395 39.719 21.7308 39.9811C21.7268 40.1559 21.7268 40.1559 21.7228 40.3341C21.6822 40.6246 21.6822 40.6246 21.3991 40.9106C20.7025 41.0299 20.7025 41.0299 20.2669 40.9106C19.8636 40.5811 19.547 40.2137 19.2762 39.7666C19.2762 39.6251 19.2762 39.4835 19.2762 39.3376C19.1828 39.3376 19.0894 39.3376 18.9932 39.3376C18.8056 38.7901 18.6206 38.2417 18.4359 37.6932C18.3831 37.5391 18.3303 37.385 18.2759 37.2262C17.9986 36.3985 17.7855 35.6341 17.7195 34.7617C17.6261 34.7617 17.5327 34.7617 17.4364 34.7617C17.343 33.818 17.2496 32.8742 17.1534 31.9018C16.3694 31.6783 16.3694 31.6783 15.9836 31.9387C15.2836 32.6011 15.2836 32.6011 14.889 33.4748C14.4502 33.6965 14.0994 33.6592 13.6152 33.6178C12.9955 33.2133 12.6511 32.7018 12.2973 32.0627C12.2465 31.977 12.1957 31.8913 12.1433 31.8029C11.8308 31.2484 11.654 30.8218 11.7754 30.1859C12.0701 29.9295 12.0701 29.9295 12.4565 29.7301C13.1023 29.4001 13.1023 29.4001 13.6152 28.8989C13.5826 28.5193 13.5826 28.5193 13.4737 28.1839C13.3132 28.1456 13.1526 28.1072 12.9872 28.0677C12.7376 27.9837 12.7376 27.9837 12.483 27.8979C12.4363 27.7563 12.3896 27.6148 12.3415 27.4689C12.2222 27.4499 12.1029 27.431 11.98 27.4114C11.8249 27.3861 11.6698 27.3609 11.51 27.3349C11.3557 27.31 11.2014 27.2851 11.0424 27.2595C10.6432 27.1829 10.6432 27.1829 10.3602 27.0399C10.3602 26.9456 10.3602 26.8512 10.3602 26.7539C10.2843 26.7392 10.2084 26.7244 10.1302 26.7093C9.51508 26.5293 8.92251 26.2722 8.52033 25.753C8.52033 25.6586 8.52033 25.5642 8.52033 25.467C8.31016 25.4316 8.31016 25.4316 8.09575 25.3955C7.4469 25.2152 7.08304 24.7798 6.63793 24.2912C6.41288 24.0247 6.41288 24.0247 6.1144 23.894C6.1144 23.7996 6.1144 23.7053 6.1144 23.608C6.02099 23.608 5.92759 23.608 5.83135 23.608C5.48031 23.076 5.48272 22.8075 5.5483 22.1781C6.17269 21.1083 7.74221 21.6402 8.74588 21.8016Z"
                fill="#585858"
              />
              <path
                d="M21.3995 2.44453C21.5212 2.47771 21.6429 2.51089 21.7683 2.54507C23.0369 2.97164 24.0508 3.9644 24.9703 4.91624C25.2107 5.18369 25.2107 5.18369 25.5657 5.29552C25.9283 5.44745 25.9283 5.44745 26.2175 5.80997C26.8125 6.31113 27.283 6.25836 28.0335 6.23394C28.157 6.2343 28.2805 6.23467 28.4078 6.23505C29.3039 6.22144 30.0795 6.11498 30.7402 5.44745C30.9579 5.42988 31.1764 5.42235 31.3947 5.42064C32.1649 5.36442 32.5144 5.07306 33.0345 4.51742C33.2876 4.30348 33.2876 4.30348 33.8537 4.30348C33.898 4.68779 33.898 4.68779 33.8537 5.16146C33.7432 5.2693 33.6326 5.37713 33.5187 5.48823C33.0939 5.93085 32.9769 6.25619 32.8012 6.84167C32.4761 7.82707 32.0909 8.74257 31.2858 9.42119C30.8219 9.97971 30.9201 10.6568 30.9486 11.3528C31.04 12.0009 31.2275 12.3135 31.6584 12.7855C31.98 13.1473 32.1113 13.5817 32.297 14.0272C32.7702 14.9304 32.7702 14.9304 33.5707 15.4572C33.5895 15.5588 33.6083 15.6603 33.6276 15.765C33.6651 15.9621 33.6651 15.9621 33.7034 16.1633C33.728 16.2943 33.7526 16.4254 33.778 16.5604C33.8222 16.8804 33.8222 16.8804 33.9953 17.0302C34.0125 17.6172 33.9811 18.2041 33.9599 18.7908C33.9541 19.0384 33.9541 19.0384 33.9483 19.291C33.9426 19.4498 33.937 19.6086 33.9311 19.7722C33.9242 19.991 33.9242 19.991 33.9172 20.2143C33.8454 20.6565 33.7395 20.8601 33.4292 21.1771C33.0046 21.2575 33.0046 21.2575 32.58 21.1771C32.35 20.8553 32.35 20.8553 32.1554 20.4621C31.9695 20.2687 31.7812 20.0775 31.5893 19.8901C31.5426 19.7957 31.4959 19.7014 31.4478 19.6041C31.2377 19.5333 31.2377 19.5333 31.0232 19.4611C30.864 19.1036 30.864 19.1036 30.7402 18.7461C30.6935 18.6989 30.6468 18.6518 30.5987 18.6031C30.5225 18.2539 30.4623 17.9028 30.4002 17.5508C30.3271 17.1743 30.3271 17.1743 30.1791 16.8414C29.9867 16.3383 29.896 15.8251 29.8026 15.2963C29.7836 15.194 29.7646 15.0917 29.7451 14.9863C29.6687 14.5651 29.608 14.1704 29.608 13.7413C29.5146 13.7413 29.4212 13.7413 29.3249 13.7413C29.2315 13.2694 29.1381 12.7975 29.0419 12.3113C28.598 12.3033 28.3213 12.3052 27.9097 12.4543C27.5916 12.7709 27.3307 13.1001 27.0683 13.4648C26.7775 13.7413 26.7775 13.7413 26.3419 13.7966C25.812 13.7257 25.6054 13.5375 25.2207 13.1693C25.1185 13.0837 25.0164 12.9982 24.9111 12.9101C24.569 12.4929 24.4865 12.1232 24.3716 11.5963C24.319 11.4311 24.2665 11.266 24.2123 11.0958C24.23 10.5953 24.23 10.5953 24.444 10.33C24.9911 9.83615 25.5899 9.41483 26.2114 9.02237C26.1647 8.78642 26.118 8.55048 26.0699 8.30739C25.1607 8.01551 24.2616 7.73823 23.3278 7.53878C22.6499 7.37407 22.2568 7.1492 21.7633 6.65901C21.4778 6.3885 21.1515 6.2156 20.8091 6.02782C20.0258 5.56952 19.3927 5.03806 18.8521 4.30348C18.7266 4.19731 18.6011 4.09113 18.4717 3.98174C18.0269 3.44722 18.0191 2.98216 18.0029 2.30153C19.1023 1.70193 20.2566 2.12919 21.3995 2.44453Z"
                fill="#595959"
              />
            </g>
            <defs>
              <filter
                id="filter0_f_1050_1382"
                x="0"
                y="0"
                width="36"
                height="43"
                filterUnits="userSpaceOnUse"
                color-interpolation-filters="sRGB"
              >
                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                <feBlend
                  mode="normal"
                  in="SourceGraphic"
                  in2="BackgroundImageFix"
                  result="shape"
                />
                <feGaussianBlur
                  stdDeviation="1"
                  result="effect1_foregroundBlur_1050_1382"
                />
              </filter>
            </defs>
          </svg>

          <p> Birds</p>
        </Button>
      </Buttons>
      <PlanePlaceholder ref={cursorFollower}>
        {shadowType == "plane" ? (
          <svg
            width="316"
            height="408"
            viewBox="0 0 316 408"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <g filter="url(#filter0_f_1008_4614)">
              <path d="M273.475 239.256C295.627 241.132 304.819 227.393 306.645 220.289C303.294 192.811 272.994 201.665 255.884 193.571C242.197 187.096 240.168 176.561 240.865 172.103C243.475 160.903 245.535 133.602 245.494 128.002C245.291 100.232 246.96 90.866 246.421 79.9591L246.421 79.9587C245.883 69.0515 244.446 39.9672 245.188 25.7653C245.782 14.4037 241.03 13.5016 238.579 14.4708C235.695 13.6277 227.178 11.4033 216.179 9.25102C205.181 7.09877 203.462 15.3574 203.977 19.7558L194.899 58.7121L184.346 103.999C182.076 113.738 182.946 145.258 181.456 158.259C180.265 168.66 175.715 173.35 173.589 174.394C137.583 170.282 64.7619 161.561 61.5281 159.576C57.486 157.094 60.4363 144.433 58.7109 127.602C56.9856 110.771 52.636 111.812 36.68 107.58C23.9152 104.195 19.8067 111.691 19.348 115.863C16.3048 125.251 9.97905 147.256 9.02193 160.176C8.06482 173.096 12.975 210.041 15.5498 226.898C21.8534 229.223 36.1484 233.238 42.8996 230.704C49.6508 228.17 56.8265 196.643 59.5704 181.196C68.7533 191.14 144.363 212.421 181.02 221.819C176.16 251.49 189.76 305.485 192.251 332.249C194.742 359.013 192.983 393 197.366 394.022C201.748 395.043 227.297 399.97 233.334 398.296C239.371 396.622 238.663 360.006 243.297 331.309C247.93 302.612 241.133 256.876 242.608 250.545C244.083 244.215 245.785 236.911 273.475 239.256Z" />
            </g>
            <defs>
              <filter
                id="filter0_f_1008_4614"
                x="0.000391006"
                y="0.000391006"
                width="315.544"
                height="407.54"
                filterUnits="userSpaceOnUse"
                colorInterpolationFilters="sRGB"
              >
                <feFlood floodOpacity="0" result="BackgroundImageFix" />
                <feBlend
                  mode="normal"
                  in="SourceGraphic"
                  in2="BackgroundImageFix"
                  result="shape"
                />
                <feGaussianBlur
                  stdDeviation="4.45"
                  result="effect1_foregroundBlur_1008_4614"
                />
              </filter>
            </defs>
          </svg>
        ) : (
          <Flock ref={bird}>
            <BirdFlapping></BirdFlapping>
            <BirdFlapping></BirdFlapping>
            <BirdFlapping></BirdFlapping>
            <BirdFlapping></BirdFlapping>
          </Flock>
        )}
      </PlanePlaceholder>
    </PageWrapper>
  );
}
